Exam 项目自动化静态资源处理复盘分享
===

> 2017.03.24
> 
> PC Web端 题库项目 v3.1.0 于 2017.03.23（周四）成功上线，这个版本我们对静态资源文件做了压缩处理及版本修订，在各位同事的共同努力下成功将`静态资源处理`部署至服务器并纳入版本发布自动化流程。
> 
> 这篇博文旨在结合`前端自动化构建`领域知识对本次静态资源处理工作做知识分享并复盘本版本上线该功能遇到的问题。

#### 为什么要做自动化静态资源处理？

为了构建高性能 Web，我们通常会考虑到以下2个优化方向:

|优化方向|优化手段|
|:----:|----|
|请求数量|合并脚本及图片（比如合并 css、js，CSS Sprites 技术）|
|请求带宽|精简脚本体积、移除冗余脚本代码、图片无损压缩技术|

同时，我们项目中还存在以下2个问题:

|问题|描述|
|:----:|----|
|缓存控制|应避免用户浏览器缓存而不去请求新版本资源的情况|
|代码安全|不应将 js 代码逻辑完好地暴露在公共网络中|

而以上问题都可以通过在开发编码阶段后进行静态资源文件处理去解决。

至于自动化很好理解，为了提高生产力，可以解放劳动力嘛 :blush:

#### 我们做了哪些静态资源处理？

###### 压缩 HTML 文件

* 删除换行符、空文本结点等
* 压缩 `<style></style>`中的 CSS 代码
* 压缩 `<script></script>`中的 js 代码

###### 压缩 CSS 文件

* 删除换行符、空格符、注释及最后一个属性的结尾分号；替换为简写属性等 [- 参考](https://github.com/jakubpawlowicz/clean-css#level-1-optimizations)
* IE8+ 兼容模式，控制保留 IE8+ 的 CSS Hack [- 参考](https://github.com/jakubpawlowicz/clean-css#compatibility-modes)

###### 压缩、混淆 JS 文件

* 删除无用字符
* 连接连续变量声明等
* 删除未引用的函数和变量、debugger 等
* 局部变量用 a-z 进行混淆替换

[具体参考](https://github.com/mishoo/UglifyJS2#compressor-options)

###### 压缩图片

* 对 .jpg, .png, .gif, .svg 格式的图片资源进行无损压缩

###### 版本修订

* 通过对文件内容进行哈希校验的方式，为资源文件命名加哈希后缀，e.g: `chapter.js` -> `chapter-dbfaeb5f77.js`，并输出 `rev-manifest.json` 文件用来指示文件命名修改前后的路径及文件名变化
* 检索上步骤输出的 `rev-manifest.json`，并对模板文件中（.html, .vm, .jsp）对资源的引用 url 同样添加对应的哈希值
